<html>
<head>
  <title>AssemblyScript Editor</title>
  <meta charset="utf-8" />
  <style>
    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
      font-size: 16px;
      color: #aaa;
      background: #1e1e1e;
    }

    /* Header (not visible if sandboxed) */
    #header {
      display: none;
      background: #007acc;
      font-size: 12px;
      color: #fff;
      padding: 5px 10px;
      height: 25px;
      box-sizing: border-box;
    }
    #header h1 {
      float: left;
      font-size: 1em;
      font-weight: normal;
      margin: 0;
    }
    #header p {
      float: right;
      margin: 0;
    }
    #header a {
      color: #fff;
    }

    /* Loading indicator */
    #loading {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 30, 30, 0.8) url(images/loading.gif) center center no-repeat;
      z-index: 9000;
      user-select: none;
    }

    /* Editor tabs */
    #tabs {
      background: #2d2d2d;
      padding: 10px 10px 0 10px;
      user-select: none;
      height: 46px;
      box-sizing: border-box;
    }
    #tabs .tab {
      font-size: 0.9rem;
      font-weight: 300;
      padding: 8px 16px 8px 34px;
      background: #2d2d2d;
      background-size: 20px 20px;
      background-repeat: no-repeat;
      background-position: 8px center;
      display: inline-block;
      cursor: pointer;
      text-decoration: none;
    }
    #tabs .tab.active {
      color: #fff;
      background-color: #1e1e1e;
    }
    #tabs .tab.disabled {
      display: none;
    }
    #tabs .tab.source {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PHRpdGxlPmZpbGVfdHlwZV90eXBlc2NyaXB0X29mZmljaWFsPC90aXRsZT48cG9seWdvbiBwb2ludHM9IjIgMTYgMiAzMCAxNiAzMCAzMCAzMCAzMCAxNiAzMCAyIDE2IDIgMiAyIDIgMTYiIHN0eWxlPSJmaWxsOiMwMDdhY2MiLz48cGF0aCBkPSJNMjQuNTY0LDE0Ljg4NGEzLjQ4NSwzLjQ4NSwwLDAsMSwxLjc1MSwxLjAwOSw0LjYxMSw0LjYxMSwwLDAsMSwuNjcxLjljLjAwOS4wMzYtMS4yMDkuODUzLTEuOTQ3LDEuMzExLS4wMjcuMDE4LS4xMzMtLjEtLjI1My0uMjc2YTEuNTg3LDEuNTg3LDAsMCwwLTEuMzE2LS43OTFjLS44NDktLjA1OC0xLjQuMzg3LTEuMzkxLDEuMTI5YTEuMDI3LDEuMDI3LDAsMCwwLC4xMi41MjRjLjE4Ny4zODcuNTMzLjYxOCwxLjYyMiwxLjA4OSwyLC44NjIsMi44NjIsMS40MzEsMy40LDIuMjRhNC4wNjMsNC4wNjMsMCwwLDEsLjMyNCwzLjQxMywzLjc1MywzLjc1MywwLDAsMS0zLjEsMi4yMTgsOC41ODQsOC41ODQsMCwwLDEtMi4xMzMtLjAyMiw1LjE0NSw1LjE0NSwwLDAsMS0yLjg0OS0xLjQ4NCw0Ljk0Nyw0Ljk0NywwLDAsMS0uNzI5LTEuMDgsMi4wOTIsMi4wOTIsMCwwLDEsLjI1OC0uMTY0Yy4xMjQtLjA3MS42LS4zNDIsMS4wNC0uNmwuOC0uNDY3TDIxLDI0LjA4QTMuNzU5LDMuNzU5LDAsMCwwLDIyLjA2NywyNS4xYTIuNiwyLjYsMCwwLDAsMi43MjQtLjEzOCwxLjIxNywxLjIxNywwLDAsMCwuMTU2LTEuNTUxYy0uMjE4LS4zMTEtLjY2Mi0uNTczLTEuOTI0LTEuMTJhNi45Myw2LjkzLDAsMCwxLTIuNjM2LTEuNjIyLDMuNjkyLDMuNjkyLDAsMCwxLS43NjktMS40LDUuNjA2LDUuNjA2LDAsMCwxLS4wNDktMS43ODcsMy40MTMsMy40MTMsMCwwLDEsMi44NzEtMi42NThBNy4wOTIsNy4wOTIsMCwwLDEsMjQuNTY0LDE0Ljg4NFptLTYuNTczLDEuMTY5TDE4LDE3LjJIMTQuMzU2VjI3LjU1NkgxMS43NzhWMTcuMkg4LjEzM1YxNi4wNzZhMTEuMDE4LDExLjAxOCwwLDAsMSwuMDMxLTEuMTU2Yy4wMTMtLjAxOCwyLjIzMS0uMDI3LDQuOTItLjAyMmw0Ljg5My4wMTNaIiBzdHlsZT0iZmlsbDojZmZmIi8+PC9zdmc+');
    }
    #tabs .tab.binary {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PHRpdGxlPmZpbGVfdHlwZV93YXNtPC90aXRsZT48cGF0aCBkPSJNMTkuMTUzLDIuMzVWMi41YTMuMiwzLjIsMCwxLDEtNi40LDBoMFYyLjM1SDJWMzAuMjY5SDI5LjkxOVYyLjM1WiIgc3R5bGU9ImZpbGw6IzY1NGZmMCIvPjxwYXRoIGQ9Ik04LjQ4NSwxNy40aDEuODVMMTEuNiwyNC4xMjNoLjAyM0wxMy4xNCwxNy40aDEuNzMxbDEuMzcxLDYuODFoLjAyN2wxLjQ0LTYuODFoMS44MTVsLTIuMzU4LDkuODg1SDE1LjMyOWwtMS4zNi02LjcyOGgtLjAzNmwtMS40NTYsNi43MjhoLTEuODdabTEzLjEyNCwwaDIuOTE3bDIuOSw5Ljg4NUgyNS41MTVsLS42My0yLjJIMjEuNTYybC0uNDg2LDIuMkgxOS4yMTdabTEuMTEsMi40MzctLjgwNywzLjYyN2gyLjUxMkwyMy41LDE5LjgzMloiIHN0eWxlPSJmaWxsOiNmZmYiLz48L3N2Zz4=');
    }
    #tabs .tab.canvas {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PHRpdGxlPmZpbGVfdHlwZV9odG1sPC90aXRsZT48cG9seWdvbiBwb2ludHM9IjUuOTAyIDI3LjIwMSAzLjY1NSAyIDI4LjM0NSAyIDI2LjA5NSAyNy4xOTcgMTUuOTg1IDMwIDUuOTAyIDI3LjIwMSIgc3R5bGU9ImZpbGw6I2U0NGYyNiIvPjxwb2x5Z29uIHBvaW50cz0iMTYgMjcuODU4IDI0LjE3IDI1LjU5MyAyNi4wOTIgNC4wNjEgMTYgNC4wNjEgMTYgMjcuODU4IiBzdHlsZT0iZmlsbDojZjE2NjJhIi8+PHBvbHlnb24gcG9pbnRzPSIxNiAxMy40MDcgMTEuOTEgMTMuNDA3IDExLjYyOCAxMC4yNDIgMTYgMTAuMjQyIDE2IDcuMTUxIDE1Ljk4OSA3LjE1MSA4LjI1IDcuMTUxIDguMzI0IDcuOTgxIDkuMDgzIDE2LjQ5OCAxNiAxNi40OTggMTYgMTMuNDA3IiBzdHlsZT0iZmlsbDojZWJlYmViIi8+PHBvbHlnb24gcG9pbnRzPSIxNiAyMS40MzQgMTUuOTg2IDIxLjQzOCAxMi41NDQgMjAuNTA5IDEyLjMyNCAxOC4wNDQgMTAuNjUxIDE4LjA0NCA5LjIyMSAxOC4wNDQgOS42NTQgMjIuODk2IDE1Ljk4NiAyNC42NTQgMTYgMjQuNjUgMTYgMjEuNDM0IiBzdHlsZT0iZmlsbDojZWJlYmViIi8+PHBvbHlnb24gcG9pbnRzPSIxNS45ODkgMTMuNDA3IDE1Ljk4OSAxNi40OTggMTkuNzk1IDE2LjQ5OCAxOS40MzcgMjAuNTA3IDE1Ljk4OSAyMS40MzcgMTUuOTg5IDI0LjY1MyAyMi4zMjYgMjIuODk2IDIyLjM3MiAyMi4zNzQgMjMuMDk4IDE0LjIzNyAyMy4xNzQgMTMuNDA3IDIyLjM0MSAxMy40MDcgMTUuOTg5IDEzLjQwNyIgc3R5bGU9ImZpbGw6I2ZmZiIvPjxwb2x5Z29uIHBvaW50cz0iMTUuOTg5IDcuMTUxIDE1Ljk4OSA5LjA3MSAxNS45ODkgMTAuMjM1IDE1Ljk4OSAxMC4yNDIgMjMuNDQ1IDEwLjI0MiAyMy40NDUgMTAuMjQyIDIzLjQ1NSAxMC4yNDIgMjMuNTE3IDkuNTQ4IDIzLjY1OCA3Ljk4MSAyMy43MzIgNy4xNTEgMTUuOTg5IDcuMTUxIiBzdHlsZT0iZmlsbDojZmZmIi8+PC9zdmc+');
    }

    /* Editor buttons */
    #buttons {
      user-select: none;
      float: right;
      padding: 15px 40px 0 0;
    }
    #buttons a {
      color: #c7c4c7;
      padding: 1px 0.2rem;
      text-align: center;
      text-decoration: none !important;
      cursor: pointer;
      opacity: 0.5;
    }
    #buttons a:hover {
      color: #fff;
      opacity: 1.0;
    }

    /* Popups */
    .popup {
      position: absolute;
      background: #3c3c3c;
      padding: 0.5rem;
      z-index: 2501;
      animation: fadeIn 83ms linear;
      box-shadow: 0 3px 3px 1px rgba(0,0,0,0.3);
      display: none;
      font-size: 0.8rem;
      user-select: none;
    }
    .popup:before {
      content: "";
      position: absolute;
      top: -24px;
      right: 0;
      border: solid 12px transparent;
      border-bottom-color: #3c3c3c;
      z-index: 2502;
      pointer-events: none;
    }

    /* Options */
    #options h5 {
      padding: 5px 0;
      margin: 0;
      color: #aaa;
    }
    #options p {
      margin: 0;
      padding: 0.2em 0;
      color: #fff;
    }
    #options p:first-child {
      padding-top: 0;
    }
    #options label {
      position: relative;
      top: -2px;
      cursor: pointer;
    }

    /* Editor panes */
    .pane {
      position: absolute;
      width: 100%;
      height: calc(100% - 46px);
      z-index: 0;
    }
    .pane.active {
      z-index: 1;
    }
    #clipboardHelper {
      position: absolute;
      z-index: 0;
      width: 100%;
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Definitely not the AssemblyScript playground</h1>
    <p>
      <a href="https://assemblyscript.org" target="_blank" rel="noopener">Documentation</a> &nbsp;
      <a href="https://github.com/AssemblyScript" target="_blank" rel="noopener">GitHub</a>
    </p>
  </div>
  <div id="loading"></div>
  <div id="buttons">
    <a class="button share" title="Copy shareable link">üîó</a>
    <a class="button options" title="Configure compiler options">‚öôÔ∏è</a>
  </div>
  <div id="options" class="popup">
    <h5>Optimize</h5>
    <div class="option">
      <p>
        <input type="radio" name="option-optimize" id="option-optimize-speed" checked /><label for="option-optimize-speed"> For speed</label>
        <input type="radio" name="option-optimize" id="option-optimize-size" /><label for="option-optimize-size"> For size</label>
        <input type="radio" name="option-optimize" id="option-optimize-none" /><label for="option-optimize-none"> None</label>
      </p>
      <!--<p><input id="option-debug" type="checkbox" /><label for="option-debug"> Include debug info</label></p>-->
    </div>
    <h5>Runtime</h5>
    <div class="option">
      <p>
        <input type="radio" name="option-runtime" id="option-runtime-full" /><label for="option-runtime-full"> Full</label>
        <input type="radio" name="option-runtime" id="option-runtime-half" checked /><label for="option-runtime-half"> Half</label>
        <input type="radio" name="option-runtime" id="option-runtime-stub" /><label for="option-runtime-stub"> Stub</label>
        <input type="radio" name="option-runtime" id="option-runtime-none" /><label for="option-runtime-none"> None</label>
      </p>
    </div>
    <h5>Features</h5>
    <div class="option">
      <p><input id="option-exportMemory" type="checkbox" checked /><label for="option-exportMemory"> Export memory to host</label></p>
      <p><input id="option-importMemory" type="checkbox" /><label for="option-importMemory"> Import memory from host</label></p>
      <p><input id="option-exportTable" type="checkbox" /><label for="option-exportTable"> Export table to host</label></p>
      <p><input id="option-importTable" type="checkbox" /><label for="option-importTable"> Import table from host</label></p>
      <p><input id="option-explicitStart" type="checkbox" /><label for="option-explicitStart"> Explicit start function</label></p>
    </div>
  </div>
  <div id="clipboard" class="popup">
    Copied to clipboard. If not: Right click and open.
  </div>
  <div id="tabs">
    <a id="sourceTab" class="tab source active">input.ts</a>
    <a id="binaryTab" class="tab binary">output.wat ‚≠Ø</a>
    <a id="canvasTab" class="tab canvas disabled">index.html</a>
  </div>
  <div id="panes">
    <div id="source" class="pane source active" aria-labelledby="sourceTab"></div>
    <div id="binary" class="pane binary" aria-labelledby="binaryTab"></div>
  </div>
  <input type="text" id="clipboardHelper" />
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.20.0/min/vs/loader.js"></script>
  <script>
    require.config({
      paths: {
        'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.20.0/min/vs'
      }
    })
    window.MonacoEnvironment = {
      getWorkerUrl: function(workerId, label) {
        return `data:text/javascript;charset=utf-8,${encodeURIComponent(`
          self.MonacoEnvironment = {
            baseUrl: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.20.0/min/'
          };
          importScripts('https://cdn.jsdelivr.net/npm/monaco-editor@0.20.0/min/vs/base/worker/workerMain.js');`
        )}`
      }
    };

    const isIframe = window.parent !== window;
    if (!isIframe) {
      document.getElementById('header').style.display = 'block'
      document.getElementById('buttons').style.paddingRight = '15px'
      document.querySelectorAll('.pane').forEach(element => {
        element.style.height = 'calc(100% - 46px - 25px)'
      })
    }
    const loading = document.getElementById('loading')
    const tabs = document.getElementById('tabs')
    const sourcePane = document.getElementById('source')
    const binaryPane = document.getElementById('binary')
    const optionsPopup = document.getElementById('options')
    const clipboardPopup = document.getElementById('clipboard')
    require([
      'vs/editor/editor.main',
      'https://cdn.jsdelivr.net/npm/assemblyscript@latest/dist/sdk.js',
      'scripts/webassembly-language.js'
    ], (
      { languages, editor }, 
      { asc },
      { config: wasmLanguageConfig, tokens: wasmLanguageTokens }
    ) => {
      console.log("AssemblyScript compiler version v" + asc.version)

      // Add WebAssembly Text Format language
      languages.register({ id: 'webassembly' })
      languages.setLanguageConfiguration('webassembly', wasmLanguageConfig)
      languages.setMonarchTokensProvider('webassembly', wasmLanguageTokens)

      // Extend the default theme with WebAssembly rules
      editor.defineTheme('vs-wasm', {
        base: 'vs-dark',
        inherit: true,
        rules: [
          // WebAssembly
          { token: 'instruction', foreground: 'dcdcaa' },
          { token: 'controlInstruction', foreground: 'c586c0' },
          { token: 'identifier', foreground: '9cdcf0' },
          // TypeScript (reset)
          { token: 'identifier.ts', foreground: 'd4d4d4' },
          // Diagnostics
          { token: 'error', foreground: 'd16969' },
          { token: 'warning', foreground: 'dcdcaa' },
          { token: 'info', foreground: '11a8cd' },
          { token: 'pedantic', foreground: 'c586c0' },
          { token: 'underline', foreground: 'd16969' }
        ]
      })

      // Add AssemblyScript Standard Library definition
      languages.typescript.typescriptDefaults.addExtraLib(asc.definitionFiles.assembly, "assemblyscript/std/assembly/index.d.ts")

      // Obtain the source provided via the location's hash
      let source = document.location.hash
      if (source.length > 1) {
        source = source.substr(1)
        try {
          source = atob(source)
        } catch (e) {
          source = `/* ${e.message} */`
        }
      } else {
        source = ''
      }

      // Common editor options
      const commonEditorOptions = {
        value: '',
        theme: 'vs-wasm',
        automaticLayout: true,
        scrollBeyondLastLine: false,
        minimap: {
          enabled: false
        },
        // contextmenu: false,
        renderLineHighlight: 'none'
      }

      // Create TypeScript editor
      const sourceEditor = editor.create(sourcePane, Object.assign({}, commonEditorOptions, {
        value: source,
        language: 'typescript',
      }))

      // Create WebAssembly editor (readonly)
      const binaryEditor = editor.create(binaryPane, Object.assign({}, commonEditorOptions, {
        value: '(module\n üöÄ\n)\n',
        language: 'webassembly',
        // readOnly: true
      }))

      // Make tabs switchable
      document.querySelectorAll('.tab').forEach(element => {
        element.addEventListener('click', () => {
          if (optionsVisible) toggleOptions(null)
          document.querySelectorAll('.tab').forEach(element => element.classList.remove('active'))
          element.classList.add('active')
          document.querySelectorAll('.pane').forEach(element => element.classList.remove('active'))
          const pane = document.getElementById(element.id.substring(0, element.id.length - 3))
          pane.classList.add('active')
          if (element.id == 'binaryTab') {
            binaryEditor.setValue('(module\n üöÄ\n)\n')
            setTimeout(() => {
              compile()
            }, 10)
          }
        })
      })

      // Make options clickable
      let optionsVisible = false
      function toggleOptions(evt) {
        if (optionsVisible = !optionsVisible) {
          optionsPopup.style.display = 'block'
          const bounds = evt.target.getBoundingClientRect()
          optionsPopup.style.top = (bounds.y + bounds.height + 12) + 'px'
          optionsPopup.style.right = (window.innerWidth - (bounds.x + bounds.width / 2) - 12) + 'px'
        } else {
          optionsPopup.style.display = 'none'
        }
      }
      document.querySelector('.button.options').addEventListener('click', toggleOptions)

      // Make contents shareable
      let clipboardTimer = null
      document.querySelector('.button.share').addEventListener('click', evt => {
        const helper = document.getElementById('clipboardHelper')
        const link = document.location.protocol + '//' + document.location.host + document.location.pathname + '#' + btoa(sourceEditor.getValue())
        helper.value = link
        helper.select()
        document.execCommand('copy')
        helper.value = ''
        helper.focus()
        clipboardPopup.style.display = 'block'
        const button = evt.target
        button.setAttribute('href', link)
        const bounds = button.getBoundingClientRect()
        clipboardPopup.style.top = (bounds.y + bounds.height + 12) + 'px'
        clipboardPopup.style.right = (window.innerWidth - (bounds.x + bounds.width / 2) - 12) + 'px'
        if (clipboardTimer) clearTimeout(clipboardTimer)
        clipboardTimer = setTimeout(() => {
          clipboardPopup.style.display = 'none'
          clipboardTimer = null
        }, 3000)
      })

      // Gets user specified compiler options
      function getCompilerOptions() {
        const options = []
        if (document.getElementById('option-optimize-speed').checked) {
          options.push('-O3')
        } else if (document.getElementById('option-optimize-size').checked) {
          options.push('-O3z', '--converge')
        }
        if (document.getElementById('option-runtime-full').checked) {
          options.push('--runtime', 'full')
        } else if (document.getElementById('option-runtime-half').checked) {
          options.push('--runtime', 'half')
        } else if (document.getElementById('option-runtime-stub').checked) {
          options.push('--runtime', 'stub')
        } else if (document.getElementById('option-runtime-none').checked) {
          options.push('--runtime', 'none')
        }
        if (!document.getElementById('option-exportMemory').checked) {
          options.push('--noExportMemory')
        }
        if (document.getElementById('option-importMemory').checked) {
          options.push('--importMemory')
        }
        if (document.getElementById('option-exportTable').checked) {
          options.push('--exportTable')
        }
        if (document.getElementById('option-importTable').checked) {
          options.push('--importTable')
        }
        if (document.getElementById('option-explicitStart').checked) {
          options.push('--explicitStart')
        }
        return options
      }

      // Compiles the source to WebAssembly
      function compile() {
        const stdout = asc.createMemoryStream()
        const sources = {
          'input.ts': sourceEditor.getValue()
        }
        const outputs = {}
        const options = [
          'input.ts',
          '--textFile', 'output.wat'
        ].concat(getCompilerOptions())
        setTimeout(() => {
          asc.main(options, {
            stdout,
            stderr: stdout,
            readFile: name => Object.prototype.hasOwnProperty.call(sources, name) ? sources[name] : null,
            writeFile: (name, contents) => outputs[name] = contents,
            listFiles: () => []
          }, err => {
            let output = stdout.toString().trim()
            if (output.length) {
              output = ';; ' + output.replace(/\n/g, '\n;; ') + '\n'
            }
            output = ';; INFO Invocation: asc ' + options.join(' ') + '\n' + output
            if (err) {
              binaryEditor.setValue(output + `(module\n ;; FAILURE ${err.message}\n)\n`)
            } else {
              binaryEditor.setValue(output + outputs['output.wat'])
            }
          })
        }, 100)
      }

      // Finally, hide the loading animation
      document.getElementById('loading').style.display = 'none'
    })
  </script>
</body>
</html>
